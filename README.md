## Шаблон E2E‑тестов на Playwright + pytest с авторизацией через localStorage

Этот `README` предназначен как **промт/шаблон для новых проектов**, в которых:
- используется **Python + pytest + Playwright**;
- есть **авторизация**, состояние которой хранится в **localStorage / cookies**;
- нужно повторно использовать сохранённое состояние авторизации в тестах.

Используйте данный текст как основу: скопируйте структуру, адаптируйте имена файлов, URL и селекторы под своё приложение.

---

## Структура проекта

Текущая структура репозитория:

```text
├── pages/                     # Page Object Model (POM) для экранов приложения
│   ├── auth_page.py           # Страница авторизации
│   └── __init__.py
├── tests/                     # Тесты (pytest)
│   ├── test_auth_page.py      # Тесты страницы авторизации
│   └── __init__.py
├── conftest.py                # Общие фикстуры pytest, создание страниц и авторизованных контекстов
├── pytest.ini                 # Конфигурация pytest (опции запуска, маски файлов, директории тестов)
├── .gitignore                 # Что не должно попадать в git
├── .env                       # Переменные окружения (URLы, логины, пароли, коды и т.п.)
├── requirements.txt           # Python‑зависимости (Playwright, pytest и др.)
└── README.md                  # Текущий шаблон / документация
```

> Файл **`.env`** должен быть в `.gitignore` (в этом репозитории он уже игнорируется).
> Если позже добавите `auth_state.json` (storage_state Playwright) — его тоже нужно игнорировать.

---

## Стек

- **Язык**: Python 3.8+ (рекомендуется 3.10+)
- **Тестовый фреймворк**: pytest
- **Браузерная автоматизация**: Playwright for Python
- **Загрузка конфигурации**: python-dotenv (`.env`)

---

## Установка и настройка окружения

### 1. Создание виртуального окружения в корне проекта (опционально, но рекомендуется)

```bash
# убедитесь, что вы находитесь в корне репозитория
# (там, где лежат README.md и requirements.txt)
python -m venv .venv

.venv\Scripts\activate         # Windows PowerShell / cmd
```

Такое разворачивание создаёт директорию виртуального окружения `.venv` **внутри проекта**.
Она уже добавлена в `.gitignore`, поэтому не попадёт в коммиты и не "замусорит" репозиторий.

### 2. Установка зависимостей

```bash
pip install -r requirements.txt

# Установка браузеров Playwright
python -m playwright install
```

### 3. Конфигурация pytest (`pytest.ini`)

Пример базовой конфигурации:

```ini
[pytest]
addopts = --headed           ; запуск браузера в видимом режиме (по необходимости можно убрать)
testpaths = tests            ; директория с тестами
python_files = test_*.py     ; маска файлов с тестами
```

При необходимости дополняйте `addopts` (маркировки, плагины, отчёты и т.д.).

---

## Настройка переменных окружения (`.env`)

Создайте файл `.env` в корне проекта и опишите в нём настройки тестового стенда и тестовые учётные данные. Пример:

```env
BASE_URL=https://your-app.example.com
USERNAME=test.user@example.com
PASSWORD=your_password
```

В коде подключайте переменные через `python-dotenv`:

- в начале `conftest.py` / `auth_helper.py` вызывается `load_dotenv()`;
- далее используйте `os.getenv("BASE_URL")`, `os.getenv("USERNAME")` и т.п.

В новом проекте обязательно **замените значения** на актуальные для вашего стенда.

---

## Что должно быть в `.gitignore`

В шаблоне уже есть файл `.gitignore`, который не даёт вносить в git:

- **виртуальное окружение**: `.venv/`;
- **кэш Python/pytest**: `__pycache__/`, `*.py[cod]`, `.pytest_cache/`;
- **артефакты Playwright**: `playwright-report/`, `test-results/`;
- **конфиденциальные данные и временные артефакты**: `.env`, `auth_state.json`.

При создании нового проекта:

- **оставьте** эти записи в `.gitignore`, чтобы не коммитить секреты и тяжёлые артефакты;
- при необходимости добавьте свои локальные файлы/папки (например, дополнительные отчёты, временные каталоги).

---

## Работа с авторизацией и localStorage

### 1. Скрипт сохранения авторизационного состояния (`auth_helper.py`)

Идея паттерна:

- один раз вручную описать полный **флоу авторизации** в коде (`auth_helper.py`), используя Page Object‑ы из `pages/`;
- выполнить скрипт, чтобы Playwright сохранил текущее `storage_state` (cookies + localStorage + др.) в файл `auth_state.json`;
- далее в тестах переиспользовать это состояние при создании контекстов браузера.

Общая схема работы `auth_helper.py`:

1. Запускается Playwright (`sync_playwright()`), создаётся браузер и новый `browser_context`.
2. Через POM‑классы (`PreAuthPage`, `AuthPage`, `LoginPage` и т.п.) выполняются шаги авторизации:
   - переход на `BASE_URL`;
   - ввод `USERNAME` и `PASSWORD`.
3. После успешной авторизации вызывается `context.storage_state()` и результат сохраняется в `auth_state.json`.

В новом проекте вы:

- адаптируете Page Object‑ы в `pages/` (селекторы, тексты, URLы);
- изменяете логику внутри `auth_helper.py` под фактический сценарий входа в ваше приложение;
- при необходимости добавляете/удаляете шаги (например, если нет предварительного экрана `pre_auth_page.py`).

Для генерации состояния запустите скрипт:

```bash
python auth_helper.py
```

После успешного выполнения в корне появится/обновится файл `auth_state.json` с cookies и localStorage.

### 2. Использование `auth_state.json` в фикстурах (`conftest.py`)

В `conftest.py` настраиваются фикстуры pytest, которые:

- создают базовую страницу `page` (размер окна, таймауты, локаль);
- инициализируют страницы (`PreAuthPage`, `AuthPage`, `MainPage` и т.д.);
- создают **авторизованный контекст** с помощью `storage_state`.

Ключевая идея:

- фикстура `auth_state` возвращает путь к файлу состояния (`"auth_state.json"`);
- фикстура `authenticated_page` создаёт `browser.new_context(storage_state=auth_state)` и на его основе `page`;
- далее поверх `authenticated_page` строятся POM‑объекты, например `MainPage`.

В новом проекте:

- сохраните сам паттерн (разделение на `page`, `authenticated_page`, страницы и т.д.);
- при необходимости поменяйте размеры окна, таймауты, локаль и список страниц.

---

## Как использовать этот шаблон в новом проекте

1. **Склонируйте/скопируйте** базовую структуру каталогов и файлов (`pages`, `tests`, `.env`, `conftest.py`, `pytest.ini`, `requirements.txt`, `auth_helper.py`, `README.md`).  
2. **Обновите зависимости** в `requirements.txt` под свой стек (версии Python, плагины pytest, дополнительные библиотеки).
3. **Настройте `.env`**: задайте `BASE_URL` вашего приложения и тестовые учётные данные.
4. **Адаптируйте POM‑классы в `pages/`**: замените локаторы, тексты, URLы и методы под реальные страницы вашего приложения.
5. **Перепишите сценарий в `auth_helper.py`** под фактический флоу авторизации (включая работу с localStorage, если требуется дополнительная логика).
6. **Сгенерируйте `auth_state.json`** запуском `python auth_helper.py`.
7. **Проверьте/адаптируйте фикстуры в `conftest.py`**, чтобы они корректно создавали авторизованные контексты и страницы.
8. **Напишите или перенесите тесты** в `tests/`, используя существующие POM и фикстуры.

После выполнения этих шагов вы получите готовый к запуску набор E2E‑тестов для нового проекта с авторизацией, состояние которой хранится в localStorage.

---

## Запуск тестов

```bash
# Запуск всех тестов
pytest

# Запуск тестов из конкретного файла
pytest tests/test_main_page.py

# Запуск конкретного теста
pytest tests/test_main_page.py::test_some_scenario_name

# (Опционально) запуск с HTML‑отчётом, если добавлен pytest‑html
pytest --html=report.html
```

При необходимости дополняйте этот `README` разделами про структуру отчётов, интеграции в CI/CD, использование docker и др. под требования конкретного проекта.
